---
import { getCollection, getEntryBySlug } from "astro:content";

import Layout from "~/layouts/Layout.astro";

import LinkButton from "~/components/global/LinkButton.astro";
import Tree from "~/components/project/Tree.astro";
import TLDR from "~/components/project/TLDR.astro";

import globe from "~/assets/icons/globe.svg";
import Callout from "~/components/project/Callout.astro";
import IconPill from "~/components/global/IconPill.astro";

export async function getStaticPaths() {
  const projects = await getCollection("projects");

  return projects.map((x) => ({ params: { project: x.slug } }));
}

const { project: projectSlug } = Astro.params;

const project = await getEntryBySlug("projects", projectSlug);

const {
  data: { tech },
} = await getEntryBySlug("categories", "tech");

const techWithIcons = await Promise.all(
  await project.data.tags.map(async (techSlug) => {
    const techItem = tech.find((x) => x.slug === techSlug);

    return {
      ...techItem,
      icon: (
        await import(
          /* @vite-ignore */ `../../assets/icons/${techItem.icon}.svg`
        )
      ).default,
    };
  })
);

const { Content } = await project.render();
---

<Layout title="Project Page">
  <article class="project">
    <header>
      <p class="when">Summer 2022</p>
      <h1>{project.data.title}</h1>
      <ul class="tags">
        {
          techWithIcons.map((item, index) => (
            <li class="tag">
              <IconPill
                label={item.name}
                icon={item.icon}
                colour={item.colour}
              />
            </li>
          ))
        }
      </ul>
      <!-- <div class="stack">
      {project.data.stack ? <Tree tree={project.data.stack} /> : null}
    </div> -->

      <div class="info">
        <TLDR text={project.data.tldr} />
        <!-- <Callout>Tags</Callout> -->
      </div>
    </header>
    <section class="content">
      <Content />
    </section>
    {
      project.data.link && (
        <LinkButton label="check it out" url={project.data.link} icon={globe} />
      )
    }
  </article>
</Layout>

<style lang="scss" is:global>
  .content {
    h2 {
      @include section-title;

      &:not(:first-of-type) {
        margin-top: $spacing-lg;
      }
    }
    p {
      margin-bottom: $spacing-sm;
      max-width: 50ch;
    }
  }
</style>

<style lang="scss">
  .project {
    font-size: 16px;
    font-weight: 300;

    @include breakpoint(sm) {
      font-size: 20px;
    }
  }
  .when {
    color: gray;
    font-size: 0.5rem;
    margin-left: 0.25em;
    margin-bottom: 0.25rem;
    // font-weight: 500;
  }
  .stack {
    // margin-bottom: $spacing-lg;
  }
  header {
    margin-bottom: $spacing-lg;
  }
  h1 {
    font-size: 1rem;
    font-weight: normal;
    margin-bottom: 0.5rem !important;

    @include breakpoint(sm) {
      font-size: 1.5rem;
    }

    @include breakpoint(md) {
      font-size: 1.6rem;
    }
    @include breakpoint(lg) {
      font-size: 2rem;
    }
  }
  .info {
    // display: grid;
    // grid-template-columns: 1fr 1fr;
    // gap: 1rem;
  }
  .tags {
    display: flex;
    gap: $spacing-xs;
    margin-bottom: 3rem;
    font-size: 0.75rem;

    @include breakpoint(sm) {
      font-size: 1rem;
    }
  }
</style>
